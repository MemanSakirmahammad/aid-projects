<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baidu Map Converter - S & P Global</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e8f4ff 0%, #d6e7ff 100%);
            min-height: 100vh;
            padding-bottom: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 400px;
            margin-bottom: 0;
            flex: 1;
        }
        
        header {
            background: linear-gradient(90deg, #3a6ea5 0%, #2a5a8c 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
            min-height: 100px;
            border-radius: 15px 15px 0 0;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        header p {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.4;
        }
        
        .home-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            z-index: 100;
            text-decoration: none;
        }
        
        .home-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .menu-toggle {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            z-index: 100;
        }
        
        .page-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background-color: #f0f7ff;
            border-bottom: 1px solid #c8d8e8;
            transition: all 0.3s ease;
        }
        
        .page-btn {
            padding: 14px 25px;
            background-color: white;
            border: 2px solid #3a6ea5;
            border-radius: 10px;
            color: #3a6ea5;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 280px;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            white-space: nowrap;
            text-decoration: none;
            text-align: center;
        }
        
        .page-btn:hover {
            background-color: #3a6ea5;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(58, 110, 165, 0.2);
        }
        
        .page-btn.active {
            background-color: #2a5a8c;
            color: white;
            border-color: #2a5a8c;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(42, 90, 140, 0.2);
        }
        
        .page-btn i {
            font-size: 1.1rem;
        }
        
        .converter-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
        }
        
        .converter-header {
            background: linear-gradient(90deg, #3a6ea5 0%, #2a5a8c 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        
        .converter-header h1 {
            font-size: 26px;
            margin-bottom: 8px;
        }
        
        .converter-header p {
            opacity: 0.9;
            font-size: 15px;
            color: white;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 14px;
            resize: vertical;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-accent {
            background: #e74c3c;
            color: white;
        }
        
        .btn-bulk {
            background: #1a5276;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            min-height: 80px;
            font-family: Consolas, monospace;
            font-size: 16px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status {
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            display: none;
        }
        
        .status-success {
            background: rgba(39, 174, 96, 0.1);
            border: 1px solid #27ae60;
            color: #27ae60;
        }
        
        .status-error {
            background: rgba(192, 57, 43, 0.1);
            border: 1px solid #c0392b;
            color: #c0392b;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 12px 0;
        }
        
        .file-upload {
            margin-top: 12px;
            padding: 12px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }
        
        .file-upload.dragover {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-info {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            display: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .modal-btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .modal-btn-primary {
            background: #3498db;
            color: white;
        }
        
        .badge {
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .badge-success {
            background: #27ae60;
        }
        
        .badge-error {
            background: #c0392b;
        }
        
        .result-stats {
            margin: 12px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }
        
        .outer-footer {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 1200px;
            width: calc(100% - 40px);
            text-align: center;
            padding: 20px 30px;
            color: white;
            font-size: 0.85rem;
            background: linear-gradient(90deg, #3a6ea5 0%, #2a5a8c 100%);
            z-index: 1000;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .converter-footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(90deg, #3a6ea5 0%, #2a5a8c 100%);
        }
        
        .footer-counters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 8px;
        }
        
        .footer-counter {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .footer-counter-icon {
            margin-right: 5px;
        }
        
        .footer-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 15px 20px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .page-buttons {
                padding: 15px;
                gap: 10px;
                position: absolute;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                z-index: 99;
                display: none;
            }
            
            .page-buttons.show {
                display: flex;
            }
            
            .page-btn {
                width: 100%;
                max-width: 260px;
                padding: 12px 18px;
                font-size: 0.95rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .footer-counters {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
            
            .footer-info {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .outer-footer {
                font-size: 0.8rem;
                padding: 15px 20px;
                width: calc(100% - 30px);
                min-height: 50px;
            }
        }
        
        @media (max-width: 480px) {
            .page-buttons {
                gap: 8px;
            }
            
            .page-btn {
                width: 100%;
                max-width: 280px;
            }
            
            .outer-footer {
                padding: 12px 15px;
                width: calc(100% - 20px);
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="outer-footer" id="outerFooter">
        Â© 2025 meman.sakirmahammad@spglobal.com. All Rights Reserved.
    </div>
    
    <div class="container">
        <header>
            <div class="home-button" onclick="window.location.href='index.html'" title="Back to Home">
                <i class="fas fa-home"></i>
            </div>
            
            <div class="menu-toggle" id="menuToggle" title="Toggle Menu">
                <i class="fas fa-bars"></i>
            </div>
            
            <h1>S & P Global</h1>
            <p>Assets Intelligence</p>
        </header>
        
        <div class="page-buttons" id="pageButtons">
            <a href="index.html" class="page-btn">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="converter.html" class="page-btn active">
                <i class="fas fa-exchange-alt"></i> Baidu to Google Converter
            </a>
            <a href="page2.html" class="page-btn">
                <i class="fas fa-file-alt"></i> Page 2
            </a>
            <a href="page3.html" class="page-btn">
                <i class="fas fa-file-alt"></i> Page 3
            </a>
        </div>
        
        <div class="converter-container">
            <div class="converter-header">
                <h1>Baidu Map to Google Map Converter</h1>
                <p>Convert Baidu Map URLs to Google Map coordinates</p>
            </div>
            
            <div class="section">
                <h2 class="section-title">Input Baidu Map URL</h2>
                <textarea id="inputText" placeholder="Paste Baidu Map URL here..."></textarea>
                
                <div class="btn-group">
                    <button id="convertBtn" class="btn btn-primary">
                        Convert to Google Map
                    </button>
                    <button id="clearBtn" class="btn btn-secondary">Clear</button>
                    <button id="copyBtn" class="btn btn-accent">Copy Coordinates</button>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Google Map Coordinates</h2>
                <div id="outputText" class="result-box"></div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="autoCopyCheck" checked>
                    <label for="autoCopyCheck">Automatically copy results to clipboard</label>
                </div>
                
                <div id="status" class="status"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Bulk Conversion</h2>
                <p>Upload Excel or CSV file containing Baidu Map URLs</p>
                
                <div class="file-upload" id="fileUploadArea">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                    <p>Drag & Drop file here or click to browse</p>
                    <p><small>Supports Excel (.xlsx, .xls) and CSV files</small></p>
                </div>
                
                <div id="fileInfo" class="file-info">
                    <strong>Selected file:</strong> <span id="fileName">No file selected</span>
                    <br>
                    <strong>File size:</strong> <span id="fileSize">0 KB</span>
                </div>
                
                <div class="btn-group">
                    <button id="processBtn" class="btn btn-bulk" disabled>Process Bulk Conversion</button>
                </div>
            </div>
            
            <div class="converter-footer" id="converterFooter">
                <div class="footer-counters">
                    <div class="footer-counter" id="footerVisitorCounter">
                        <span class="footer-counter-icon">ðŸ“ˆ</span>
                        <span id="footerVisitorCount">Loading visitors...</span>
                    </div>
                    <div class="footer-counter" id="footerConversionCounter">
                        <span class="footer-counter-icon">ðŸ”„</span>
                        <span id="footerConversionCount">Loading conversions...</span>
                    </div>
                </div>
                <div class="footer-info">
                    <div id="statusBar">Ready</div>
                    <div>Developer: Meman Sakirmahammad on behalf of the Assets Intelligence Department</div>
                </div>
            </div>
        </div>
    </div>

    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Bulk Conversion Complete</h2>
            <div id="bulkResults">
                <p>Successfully processed <span id="totalCount">0</span> URLs</p>
                <div class="result-stats">
                    <div class="stat-row">
                        <span>Successful conversions:</span>
                        <span id="successCount" class="badge badge-success">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Errors:</span>
                        <span id="errorCount" class="badge badge-error">0</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModalBtn" class="modal-btn modal-btn-secondary">Close</button>
                <button id="downloadBtn" class="modal-btn modal-btn-primary">Download Results</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const pageButtons = document.getElementById('pageButtons');
            
            if (menuToggle && pageButtons) {
                menuToggle.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        pageButtons.classList.toggle('show');
                    }
                });
                
                // Close menu when clicking outside on mobile
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 768) {
                        if (!pageButtons.contains(event.target) && 
                            !menuToggle.contains(event.target)) {
                            pageButtons.classList.remove('show');
                        }
                    }
                });
            }
            
            // Highlight active page in navigation
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const pageLinks = document.querySelectorAll('.page-btn');
            
            pageLinks.forEach(link => {
                const linkPage = link.getAttribute('href');
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            // Baidu Map Converter functionality
            initConverter();
        });
        
        function initConverter() {
            // Elements
            const inputText = document.getElementById('inputText');
            const outputText = document.getElementById('outputText');
            const convertBtn = document.getElementById('convertBtn');
            const clearBtn = document.getElementById('clearBtn');
            const copyBtn = document.getElementById('copyBtn');
            const processBtn = document.getElementById('processBtn');
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const autoCopyCheck = document.getElementById('autoCopyCheck');
            const statusDiv = document.getElementById('status');
            const statusBar = document.getElementById('statusBar');
            const bulkModal = document.getElementById('bulkModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            // Variables
            let currentBlobUrl = null;
            let currentFile = null;
            
            // Initialize counters
            initVisitorCounter();
            initConversionCounter();
            
            // Event Listeners
            if (convertBtn) convertBtn.addEventListener('click', convertUrl);
            if (clearBtn) clearBtn.addEventListener('click', clearAll);
            if (copyBtn) copyBtn.addEventListener('click', copyCoordinates);
            if (processBtn) processBtn.addEventListener('click', processBulkConversion);
            if (fileUploadArea) fileUploadArea.addEventListener('click', () => fileInput.click());
            if (fileInput) fileInput.addEventListener('change', handleFileSelect);
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (downloadBtn) downloadBtn.addEventListener('click', handleDownload);
            
            // File upload handling
            if (fileUploadArea) {
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });
                
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileSelect(e);
                    }
                });
            }
            
            // Set focus to input
            if (inputText) {
                inputText.focus();
                
                // Enter key shortcut
                inputText.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        convertUrl();
                    }
                });
            }
            
            // Functions
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                currentFile = file;
                
                // Display file information
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';
                
                // Enable process button
                if (processBtn) processBtn.disabled = false;
                
                updateStatus(`File selected: ${file.name}`);
            }
            
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' bytes';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }
            
            function updateStatus(message, isError = false) {
                if (statusDiv) {
                    statusDiv.textContent = message;
                    statusDiv.className = isError ? 'status status-error' : 'status status-success';
                    statusDiv.style.display = 'block';
                }
                if (statusBar) {
                    statusBar.textContent = message;
                }
            }
            
            function clearAll() {
                if (inputText) inputText.value = '';
                if (outputText) outputText.textContent = '';
                if (statusDiv) statusDiv.style.display = 'none';
                if (statusBar) statusBar.textContent = 'Ready';
            }
            
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    updateStatus('Copied to clipboard');
                }).catch(err => {
                    updateStatus('Error copying to clipboard', true);
                    console.error('Failed to copy: ', err);
                });
            }
            
            function copyCoordinates() {
                if (outputText && outputText.textContent.trim()) {
                    copyToClipboard(outputText.textContent.trim());
                } else {
                    updateStatus('Error: No coordinates to copy', true);
                }
            }
            
            // Counter Functions
            function initVisitorCounter() {
                const footerVisitorCountElement = document.getElementById('footerVisitorCount');
                if (!footerVisitorCountElement) return;
                
                // Check if we've already counted this visitor in this session
                if (!sessionStorage.getItem('visited')) {
                    // Get current count from localStorage or initialize
                    let count = parseInt(localStorage.getItem('visitorCount') || '0');
                    count++;
                    
                    // Update the count
                    localStorage.setItem('visitorCount', count.toString());
                    sessionStorage.setItem('visited', 'true');
                    
                    // Update display
                    footerVisitorCountElement.textContent = `${count} Visits`;
                } else {
                    // Just display the count without incrementing
                    const count = parseInt(localStorage.getItem('visitorCount') || '0');
                    footerVisitorCountElement.textContent = `${count} visits`;
                }
            }
            
            function initConversionCounter() {
                const footerConversionCountElement = document.getElementById('footerConversionCount');
                if (!footerConversionCountElement) return;
                
                const count = parseInt(localStorage.getItem('conversionCount') || '0');
                footerConversionCountElement.textContent = `${count} Total conversions`;
            }
            
            function updateConversionCounter(additionalConversions = 1) {
                const footerConversionCountElement = document.getElementById('footerConversionCount');
                if (!footerConversionCountElement) return;
                
                let count = parseInt(localStorage.getItem('conversionCount') || '0');
                count += additionalConversions;
                localStorage.setItem('conversionCount', count.toString());
                footerConversionCountElement.textContent = `${count} total conversions`;
            }
            
            // Coordinate conversion functions
            function extractBaiduMercator(url) {
                const pattern = /@(-?\d+\.\d+|-?\d+),(-?\d+\.\d+|-?\d+),\d+\.?\d*z/;
                const match = url.match(pattern);
                if (match) {
                    return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
                }
                return { x: null, y: null };
            }

            function bdMcToBd09(x, y) {
                const MCBAND = [12890594.86, 8362377.87, 5591021, 3481989.83, 1678043.12, 0];
                const MC2LL = [
                    [1.410526172116255e-8, 0.00000898305509648872, -1.9939833816331, 200.9824383106796, 
                     -187.2403703815547, 91.6087516669843, -23.38765649603339, 2.57121317296198, 
                     -0.03801003308653, 17337981.2],
                    [-7.435856389565537e-9, 0.000008983055097726239, -0.78625201886289, 96.32687599759846, 
                     -1.85204757529826, -59.36935905485877, 47.40033549296737, -16.50741931063887, 
                     2.28786674699375, 10260144.86],
                    [-3.030883460898826e-8, 0.00000898305509983578, 0.30071316287616, 59.74293618442277, 
                     7.357984074871, -25.38371002664745, 13.45380521110908, -3.29883767235584, 
                     0.32710905363475, 6856817.37],
                    [-1.981981304930552e-8, 0.000008983055099779535, 0.03278182852591, 40.31678527705744, 
                     0.65659298677277, -4.44255534477492, 0.85341911805263, 0.12923347998204, 
                     -0.04625736007561, 4482777.06],
                    [3.09191371068437e-9, 0.000008983055096812155, 0.00006995724062, 23.10934304144901, 
                     -0.00023663490511, -0.6321817810242, -0.00663494467273, 0.03430082397953, 
                     -0.00466043876332, 2555164.4],
                    [2.890871144776878e-9, 0.000008983055095805407, -3.068298e-8, 7.47137025468032, 
                     -0.00000353937994, -0.02145144861037, -0.00001234426596, 0.00010322952773, 
                     -0.00000323890364, 826088.5]
                ];
                
                const absY = Math.abs(y);
                let c = null;
                for (let i = 0; i < MCBAND.length; i++) {
                    if (absY >= MCBAND[i]) {
                        c = MC2LL[i];
                        break;
                    }
                }
                if (c === null) {
                    throw new Error("Coordinate out of range for conversion");
                }
                
                const absX = Math.abs(x);
                let lon = c[0] + c[1] * absX;
                
                const d = absY / c[9];
                let lat = c[2] + c[3] * d + c[4] * Math.pow(d, 2) + c[5] * Math.pow(d, 3) +
                        c[6] * Math.pow(d, 4) + c[7] * Math.pow(d, 5) + c[8] * Math.pow(d, 6);
                
                if (x < 0) lon = -lon;
                if (y < 0) lat = -lat;
                    
                return { lon, lat };
            }

            function transformLat(x, y) {
                let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(y * Math.PI) + 40.0 * Math.sin(y / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (160.0 * Math.sin(y / 12.0 * Math.PI) + 320 * Math.sin(y * Math.PI / 30.0)) * 2.0 / 3.0;
                return ret;
            }

            function transformLng(x, y) {
                let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(x * Math.PI) + 40.0 * Math.sin(x / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (150.0 * Math.sin(x / 12.0 * Math.PI) + 300.0 * Math.sin(x / 30.0 * Math.PI)) * 2.0 / 3.0;
                return ret;
            }

            function bd09ToGcj02(bdLng, bdLat) {
                const xPi = Math.PI * 3000.0 / 180.0;
                const x = bdLng - 0.0065;
                const y = bdLat - 0.006;
                const z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * xPi);
                const theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * xPi);
                const gcjLng = z * Math.cos(theta);
                const gcjLat = z * Math.sin(theta);
                return { gcjLng, gcjLat };
            }

            function gcj02ToWgs84(gcjLng, gcjLat) {
                if (gcjLng < 72.004 || gcjLng > 137.8347 || gcjLat < 0.8293 || gcjLat > 55.8271) {
                    return { wgsLng: gcjLng, wgsLat: gcjLat };
                }

                const dLat = transformLat(gcjLng - 105.0, gcjLat - 35.0);
                const dLng = transformLng(gcjLng - 105.0, gcjLat - 35.0);
                const radLat = gcjLat / 180.0 * Math.PI;
                const magic = 1 - 0.00669342162296594323 * Math.pow(Math.sin(radLat), 2);
                const sqrtMagic = Math.sqrt(magic);
                
                const deltaLat = (dLat * 180.0) / ((6378137.0 * (1 - 0.00669342162296594323)) / (magic * sqrtMagic) * Math.PI);
                const deltaLng = (dLng * 180.0) / (6378137.0 / sqrtMagic * Math.cos(radLat) * Math.PI);
                
                return { wgsLng: gcjLng - deltaLng, wgsLat: gcjLat - deltaLat };
            }

            function bd09ToWgs84(bdLng, bdLat) {
                const { gcjLng, gcjLat } = bd09ToGcj02(bdLng, bdLat);
                return gcj02ToWgs84(gcjLng, gcjLat);
            }

            function bdMcToWgs84(x, y) {
                const { lon: bdLng, lat: bdLat } = bdMcToBd09(x, y);
                return bd09ToWgs84(bdLng, bdLat);
            }
            
            function convertUrl() {
                const url = inputText.value.trim();
                if (!url) {
                    updateStatus('Error: Please enter a Baidu Map URL', true);
                    return;
                }
                
                updateStatus('Converting...');
                convertBtn.disabled = true;
                convertBtn.innerHTML = '<div class="spinner"></div> Converting...';
                
                setTimeout(() => {
                    try {
                        const { x, y } = extractBaiduMercator(url);
                        if (x === null || y === null) {
                            throw new Error('Invalid Baidu Map URL format');
                        }

                        const { wgsLng, wgsLat } = bdMcToWgs84(x, y);
                        const coordinates = `${wgsLat.toFixed(6)}, ${wgsLng.toFixed(6)}`;
                        
                        outputText.textContent = coordinates;
                        
                        // Update conversion counter
                        updateConversionCounter();
                        
                        if (autoCopyCheck && autoCopyCheck.checked) {
                            copyToClipboard(coordinates);
                            updateStatus('Success: Coordinates converted and copied to clipboard');
                        } else {
                            updateStatus('Success: Coordinates converted');
                        }
                    } catch (error) {
                        updateStatus(`Error: ${error.message}`, true);
                    } finally {
                        convertBtn.disabled = false;
                        convertBtn.textContent = 'Convert to Google Map';
                    }
                }, 100);
            }
            
            function processBulkConversion() {
                if (!currentFile) {
                    updateStatus('Error: Please select a file first', true);
                    return;
                }
                
                updateStatus('Preparing bulk conversion...');
                processBtn.disabled = true;
                processBtn.innerHTML = '<div class="spinner"></div> Processing...';
                
                // Clean up previous blob URL if it exists
                if (currentBlobUrl) {
                    URL.revokeObjectURL(currentBlobUrl);
                    currentBlobUrl = null;
                }
                
                // Process the file based on extension
                const extension = currentFile.name.split('.').pop().toLowerCase();
                
                if (extension === 'csv') {
                    parseCSV(currentFile);
                } else if (['xlsx', 'xls'].includes(extension)) {
                    parseExcel(currentFile);
                } else {
                    updateStatus('Error: Unsupported file format. Please use CSV or Excel files.', true);
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process Bulk Conversion';
                }
            }
            
            function parseCSV(file) {
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        processBulkData(results.data, results.meta.fields);
                    },
                    error: function(error) {
                        updateStatus('Error parsing CSV: ' + error.message, true);
                        processBtn.disabled = false;
                        processBtn.textContent = 'Process Bulk Conversion';
                    }
                });
            }
            
            function parseExcel(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            throw new Error('Excel file does not contain enough data');
                        }
                        
                        const headers = jsonData[0];
                        const rows = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, i) => {
                                obj[header] = row[i];
                            });
                            return obj;
                        });
                        
                        processBulkData(rows, headers);
                    } catch (error) {
                        updateStatus('Error parsing Excel: ' + error.message, true);
                        processBtn.disabled = false;
                        processBtn.textContent = 'Process Bulk Conversion';
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function processBulkData(data, headers) {
                // Find URL column
                const urlColumn = headers.find(header => 
                    header && header.toLowerCase().includes('url')
                );
                
                if (!urlColumn) {
                    updateStatus('Error: No URL column found. Please include a column with "url" in its name.', true);
                    processBtn.disabled = false;
                    processBtn.textContent = 'Process Bulk Conversion';
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                const total = data.length;
                const results = [];
                
                // Process each row
                data.forEach((row, index) => {
                    try {
                        const url = row[urlColumn];
                        if (!url) {
                            results.push({
                                ...row,
                                converted_latitude: '',
                                converted_longitude: '',
                                status: 'Skipped: Empty URL'
                            });
                            errorCount++;
                            return;
                        }
                        
                        const { x, y } = extractBaiduMercator(String(url));
                        if (x === null || y === null) {
                            results.push({
                                ...row,
                                converted_latitude: '',
                                converted_longitude: '',
                                status: 'Error: Invalid URL format'
                            });
                            errorCount++;
                            return;
                        }
                        
                        const { wgsLng, wgsLat } = bdMcToWgs84(x, y);
                        results.push({
                            ...row,
                            converted_latitude: wgsLat,
                            converted_longitude: wgsLng,
                            status: 'Success'
                        });
                        successCount++;
                    } catch (error) {
                        results.push({
                            ...row,
                            converted_latitude: '',
                            converted_longitude: '',
                            status: `Error: ${error.message}`
                        });
                        errorCount++;
                    }
                    
                    // Update progress
                    const progress = ((index + 1) / total) * 100;
                    updateStatus(`Processing: ${Math.round(progress)}% complete`);
                });
                
                // Update conversion counter with successful conversions
                updateConversionCounter(successCount);
                
                // Create downloadable Excel file
                const worksheet = XLSX.utils.json_to_sheet(results);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Converted Coordinates');
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                
                // Create blob for download
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                currentBlobUrl = URL.createObjectURL(blob);
                
                // Update modal with results
                document.getElementById('totalCount').textContent = total;
                document.getElementById('successCount').textContent = successCount;
                document.getElementById('errorCount').textContent = errorCount;
                
                // Show modal
                bulkModal.style.display = 'flex';
                
                updateStatus(`Bulk conversion complete: ${successCount} successful, ${errorCount} errors`);
                processBtn.disabled = false;
                processBtn.textContent = 'Process Bulk Conversion';
                
                // Reset file selection
                fileInput.value = '';
                fileInfo.style.display = 'none';
                currentFile = null;
            }
            
            function handleDownload() {
                if (currentBlobUrl) {
                    const a = document.createElement('a');
                    a.href = currentBlobUrl;
                    a.download = 'converted_coordinates.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            }
            
            function closeModal() {
                bulkModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>